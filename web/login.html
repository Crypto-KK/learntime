<!DOCTYPE html>

<html lang="en">

<head>
  <base href="./">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
  <meta name="description" content="CoreUI - Open Source Bootstrap Admin Template">
  <meta name="author" content="Łukasz Holeczek">
  <meta name="keyword" content="Bootstrap,Admin,Template,Open,Source,jQuery,CSS,HTML,RWD,Dashboard">
  <title>学生端登录</title>

  <link href="css/style.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/4.1.0/css/bootstrap.min.css">
  <script src="https://cdn.staticfile.org/jquery/3.2.1/jquery.min.js"></script>
  <script src="https://cdn.staticfile.org/popper.js/1.12.5/umd/popper.min.js"></script>
  <script src="https://cdn.staticfile.org/twitter-bootstrap/4.1.0/js/bootstrap.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@9"></script>
  <script src="https://cdn.jsdelivr.net/npm/vue"></script>
</head>

<body class="app header-fixed align-items-center" style="background-image: linear-gradient(#409EFF, #FFFFFF);">
  <div class="container" style="margin: auto;" id="xstAPP">
    <div class="row justify-content-center">
      <div class="col-md-5">
        <div class="card-group">
          <div class="card p-4">
            <div class="card-body">
              <h1>登录</h1>
              <p class="text-muted">登录到您的学时通帐户</p>
              <div class="form-group">
                <input id="user" class="form-control" type="text" placeholder="账号" v-model="uid"
                  v-on:input="onInput(uid)">
                <div class="invalid-feedback">{{ uprompt }}</div>
              </div>
              <div class="form-group">
                <input id="psd" class="form-control" type="password" placeholder="密码" v-model="password"
                  v-on:input="onInputp(password)">
                <div class="invalid-feedback">密码不能为空</div>
              </div>
              <div class="row">
                <div class="col-6">
                  <button id="loginButton" class="btn btn-primary px-4" type="button" v-on:click="login">{{ loginText }}</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>


  <script src="js/config.js"></script>
  <script src="js/mytoast.js"></script>
  <script>
    var example1 = new Vue({
      el: "#xstAPP",
      data: {
        uid: '',
        password: '',
        uprompt: '账号不能为空',
        loginText:'登录'
      },
      methods: {
        onInput: function (uid) {
          let $user = $('#user');
          let reg = /^([0-9]{12})$/;
          if (reg.test(uid)) {
            $user.removeClass('is-invalid');
          } else {
            $user.addClass('is-invalid');
            this.uprompt = '请输入12位数的学号';
          }
        },
        onInputp: function (psd) {
          let $psd = $('#psd');
          if (psd.length > 0) {
            $psd.removeClass('is-invalid');
          } else {
            $psd.addClass('is-invalid');
          }
        },
        login: function () {
          let $user = $('#user');
          let $psd = $('#psd');
          if (this.uid == '') {
            $user.addClass('is-invalid');
          }
          if (this.password == '') {
            $psd.addClass('is-invalid');
          }
          if ($user.hasClass('is-invalid') || $psd.hasClass('is-invalid')) {
          } else {
            let that = this
            $.ajax({
              url: LOGIN,
              data: JSON.stringify({
                uid: that.uid,
                password: that.password
              }),
              type: 'POST',
              contentType: "application/json",
              dataType: "JSON",
              success: function (result, state) {
                if ((typeof (result.msg) == 'undefined')) {
                  that.loginText = '登录中...'
                  $('#loginButton').attr("disabled",true);
                  let storage = window.sessionStorage;
                  let objStr = JSON.stringify(result);
                  storage.setItem('studenti', objStr);
                  window.location.replace("index.html");
                } else {
                  Toast.error(result.msg)
                  that.uid = '';
                  that.password = '';
                }
              }, error: function (res) {
                if (429 == res.status) {
                  let hint = "请等待" + JSON.parse(res.responseText).detail.split(' ')[6] + "秒后再登录"
                  Toast.error(hint)
                }
              }

            });
          }
        }
      }
    })
  </script>
</body>

</html>